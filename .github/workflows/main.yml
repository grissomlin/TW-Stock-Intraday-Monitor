name: Intra-day Stock Monitor

on:
  # åŸä¾†çš„è§¸ç™¼æ¢ä»¶ï¼ˆä¿æŒä¸è®Šï¼‰
  schedule:
    # å°ç£æ™‚é–“ 09:30, 10:30, 11:30, 12:30, 13:30 åŸ·è¡Œ
    # åˆ†é˜è¨­ç‚º 30ï¼Œå°æ™‚è¨­ç‚º 1, 2, 3, 4, 5 (UTC)
    - cron: '30 1,2,3,4,5 * * 1-5'
  workflow_dispatch: # ä¿ç•™æ‰‹å‹•æŒ‰éˆ•
  # å¯é¸ï¼šç•¶ç¨‹å¼ç¢¼æ›´æ–°æ™‚ä¹ŸåŸ·è¡Œ
  push:
    branches: [ main ]
    paths:
      - '**.py'
      - 'requirements.txt'
      - '.github/workflows/**'

jobs:
  run-monitor:
    runs-on: ubuntu-latest
    
    env:
      SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
      SUPABASE_KEY: ${{ secrets.SUPABASE_KEY }}
      TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
      TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
      GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
    
    steps:
      - name: æª¢æŸ¥å€‰åº«
        uses: actions/checkout@v3
        with:
          fetch-depth: 0
        
      - name: è¨­å®š Python ç’°å¢ƒ
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
          cache: 'pip'
          
      - name: æª¢æŸ¥æª”æ¡ˆçµæ§‹
        run: |
          echo "ğŸ“ æª”æ¡ˆçµæ§‹:"
          ls -la
          echo -e "\nğŸ“‚ å­ç›®éŒ„:"
          find . -name "*.py" -o -name "requirements.txt" | head -20
          echo -e "\nğŸ“ Python æ¨¡çµ„:"
          python -c "import sys; print('Pythonè·¯å¾‘:', sys.path)"
        
      - name: å®‰è£ä¾è³´å¥—ä»¶
        run: |
          python -m pip install --upgrade pip
          pip install --no-cache-dir -r requirements.txt
          
          # é¡å¤–æª¢æŸ¥é—œéµå¥—ä»¶
          echo "ğŸ” æª¢æŸ¥é—œéµå¥—ä»¶ç‰ˆæœ¬:"
          python -c "
          try:
              import pandas as pd
              print(f'âœ… pandas: {pd.__version__}')
          except Exception as e:
              print(f'âŒ pandas: {e}')
          
          try:
              import google.generativeai as genai
              print(f'âœ… google.generativeai: å·²å®‰è£')
          except Exception as e:
              print(f'âŒ google.generativeai: {e}')
          
          try:
              from supabase import create_client
              print(f'âœ… supabase: å·²å®‰è£')
          except Exception as e:
              print(f'âŒ supabase: {e}')
          "
        
      - name: è¨­ç½®ç’°å¢ƒè®Šæ•¸ (æ¸¬è©¦ç”¨)
        run: |
          echo "ğŸ”§ æª¢æŸ¥ç’°å¢ƒè®Šæ•¸:"
          echo "SUPABASE_URL: ${#SUPABASE_URL} å­—å…ƒ"
          echo "SUPABASE_KEY: ${#SUPABASE_KEY} å­—å…ƒ"
          echo "TELEGRAM_BOT_TOKEN: ${#TELEGRAM_BOT_TOKEN} å­—å…ƒ"
          echo "TELEGRAM_CHAT_ID: ${TELEGRAM_CHAT_ID}"
          echo "GEMINI_API_KEY: ${#GEMINI_API_KEY} å­—å…ƒ"
          
          # å‰µå»ºè‡¨æ™‚çš„ .env æª”æ¡ˆï¼ˆåƒ…ä¾›æ¸¬è©¦ï¼‰
          if [ -n "$SUPABASE_URL" ] && [ -n "$SUPABASE_KEY" ]; then
            echo "âœ… ç’°å¢ƒè®Šæ•¸å·²è¨­ç½®"
          else
            echo "âš ï¸ éƒ¨åˆ†ç’°å¢ƒè®Šæ•¸æœªè¨­ç½®"
          fi
        
      - name: æ¸¬è©¦æ¨¡çµ„å°å…¥
        run: |
          echo "ğŸ§ª æ¸¬è©¦æ¨¡çµ„å°å…¥..."
          python -c "
          import sys
          import os
          
          # ç¢ºä¿ç•¶å‰ç›®éŒ„åœ¨ Python è·¯å¾‘ä¸­
          current_dir = os.path.dirname(os.path.abspath('.'))
          if current_dir not in sys.path:
              sys.path.insert(0, current_dir)
          
          print('Python ç‰ˆæœ¬:', sys.version)
          print('ç•¶å‰ç›®éŒ„:', os.getcwd())
          
          # æ¸¬è©¦åŸºæœ¬æ¨¡çµ„
          modules_to_test = ['pandas', 'yfinance', 'requests', 'google.generativeai', 'supabase']
          
          for module in modules_to_test:
              try:
                  __import__(module)
                  print(f'âœ… {module}: å°å…¥æˆåŠŸ')
              except ImportError as e:
                  print(f'âŒ {module}: å°å…¥å¤±æ•— - {e}')
          
          # æ¸¬è©¦è‡ªè¨‚æ¨¡çµ„
          print('\næ¸¬è©¦è‡ªè¨‚æ¨¡çµ„:')
          try:
              from ai_analyzer import StockAIAnalyzer
              print('âœ… ai_analyzer: å°å…¥æˆåŠŸ')
          except ImportError as e:
              print(f'âŒ ai_analyzer: å°å…¥å¤±æ•— - {e}')
          
          try:
              from prompts import StockPrompts
              print('âœ… prompts: å°å…¥æˆåŠŸ')
          except ImportError as e:
              print(f'âŒ prompts: å°å…¥å¤±æ•— - {e}')
          "
        
      - name: åŸ·è¡Œä¸»ç¨‹å¼
        run: |
          echo "ğŸš€ é–‹å§‹åŸ·è¡Œè‚¡ç¥¨ç›£æ§..."
          
          # è¨­ç½®æ™‚å€ç‚ºå°ç£æ™‚é–“ï¼ˆå¯é¸ï¼‰
          export TZ='Asia/Taipei'
          
          # åŸ·è¡Œä¸»ç¨‹å¼
          python main_pipeline.py
          
          # æª¢æŸ¥åŸ·è¡Œçµæœ
          if [ $? -eq 0 ]; then
            echo "âœ… ç¨‹å¼åŸ·è¡ŒæˆåŠŸ"
          else
            echo "âŒ ç¨‹å¼åŸ·è¡Œå¤±æ•—"
            exit 1
          fi
        
      - name: æ¸…ç†ç·©å­˜ï¼ˆå¯é¸ï¼‰
        if: always()
        run: |
          echo "ğŸ§¹ æ¸…ç†ç·©å­˜..."
          pip cache purge || true
        
      - name: åŸ·è¡Œå®Œæˆé€šçŸ¥ï¼ˆå¯é¸ï¼‰
        if: always()
        run: |
          echo "ğŸ å·¥ä½œæµç¨‹åŸ·è¡Œå®Œæˆ"
          date
          echo "GitHub Actions é‹è¡Œæ™‚é–“: ${{ github.run_id }}"
